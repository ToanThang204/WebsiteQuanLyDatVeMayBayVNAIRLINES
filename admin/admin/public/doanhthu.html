<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TripMa Admin - Thống kê doanh thu</title>
    <link rel="stylesheet" href="./css/style.css" />
    <link rel="stylesheet" href="./css/components.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
     
    </style>
  </head>
  <body>
    <body>
      <div class="admin-container">
          <!-- Sidebar -->
          <nav class="sidebar">
              <div class="sidebar-header">
                  <h2>Quản trị</h2>
                  <span>Bảng điều khiển</span>
              </div>
              
              <ul class="sidebar-menu">
                  <li class="menu-item">
                      <a href="index.html">
                          <i class="fas fa-home"></i>
                          <span>Trang chủ</span>
                      </a>
                  </li>
                  
                  <li class="menu-item">
                      <a href="admins.html">
                          <i class="fas fa-users-cog"></i>
                          <span>Quản trị viên</span>
                      </a>
                  </li>
                  
                  <li class="menu-item">
                      <a href="flights.html">
                          <i class="fas fa-plane"></i>
                          <span>Chuyến bay</span>
                      </a>
                  </li>
                  
                  <li class="menu-item">
                      <a href="aircraft.html">
                          <i class="fas fa-plane-departure"></i>
                          <span>Máy bay</span>
                      </a>
                  </li>
                  
                  <li class="menu-item">
                      <a href="services.html">
                          <i class="fas fa-concierge-bell"></i>
                          <span>Dịch vụ</span>
                      </a>
                  </li>
                  
                  <li class="menu-item">
                      <a href="airports.html">
                          <i class="fas fa-plane-arrival"></i>
                          <span>Sân bay</span>
                      </a>
                  </li>
                  
                  <li class="menu-item">
                      <a href="ve.html">
                          <i class="fas fa-ticket-alt"></i>
                          <span>Vé máy bay</span>
                      </a>
                  </li>
                  
                  <li class="menu-item">
                      <a href="hoadon.html">
                          <i class="fas fa-file-invoice-dollar"></i>
                          <span>Hóa đơn</span>
                      </a>
                  </li>
                  <li class="menu-item active">
                    <a href="doanhthu.html">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <span>Doanh Thu</span>
                    </a>
                </li>
              </ul>
          </nav>
    
    <div class="doanhthu-container container mt-4">
      
      <div class="header d-flex justify-content-between align-items-center mb-4">
        <h1>Thống kê doanh thu</h1>
        <a href="index.html" class="back-btn btn btn-secondary">
          <i class="fas fa-arrow-left"></i> Quay lại
        </a>
        <div class="header-right">
                    <div class="notifications">
                        <button class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">3</span>
                        </button>
                    </div>
                    
                    <div class="user-menu">
                        <div class="user-info">
                            <span id="adminName">Admin</span>
                        </div>
                        <button class="sign-out-btn" onclick="logout()">Đăng xuất</button>
                    </div>
                </div>
        
      </div>

      <div class="date-filter d-flex align-items-center mb-4">
        <label for="dateFilter" class="form-label me-2">Chọn ngày:</label>
        <input type="date" id="dateFilter" class="form-control" style="width: auto;" />
        <button class="filter-btn btn btn-primary ms-2">
          <i class="fas fa-filter"></i> Lọc theo ngày
        </button>
      </div>

      <div class="stats-grid row mb-4">
        <div class="col-md-6 col-lg-4 mb-4">
          <div class="stat-card total-revenue">
            <i class="fas fa-dollar-sign"></i>
            <div class="stat-content">
              <h3>Tổng doanh thu</h3>
              <div class="stat-value" id="totalRevenue">Loading...</div>
            </div>
          </div>
        </div>
        <div class="col-md-6 col-lg-4 mb-4">
          <div class="stat-card daily-revenue">
            <i class="fas fa-calendar-day"></i>
            <div class="stat-content">
              <h3>Doanh thu ngày được chọn</h3>
              <div class="stat-value" id="selectedDateRevenue">-</div>
            </div>
          </div>
        </div>
      </div>

      <div class="chart-container card mb-4">
        <div class="card-header">
            <h3>Doanh thu theo ngày</h3>
        </div>
        <div class="card-body">
            <canvas id="dailyRevenueChart"></canvas>
        </div>
      </div>

      <div class="chart-container card mb-4">
         <div class="card-header">
            <h3>Doanh thu theo tháng</h3>
         </div>
         <div class="card-body">
            <canvas id="monthlyRevenueChart"></canvas>
         </div>
      </div>

      <div class="table-container card">
        <div class="card-header">
            <h3>Chi tiết hóa đơn theo ngày</h3>
        </div>
        <div class="card-body table-responsive">
          <table id="dailyInvoicesTable" class="table table-striped table-hover">
            <thead>
              <tr>
                <th>Mã hóa đơn</th>
                <th>Thời gian</th>
                <th>Khách hàng</th>
                <th>Số điện thoại</th>
                <th>Tổng tiền</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="5" class="loading-initial">Đang tải dữ liệu...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      // Base URL for API calls
      const API_BASE_URL = "http://localhost:3000/api/revenue";

      // --- Utility Functions ---

      // Kiểm tra xác thực
      function checkAuth() {
        const token = localStorage.getItem("adminToken");
        if (!token) {
          window.location.href = "login.html";
          return null; // Return null if not authenticated
        }
        return token;
      }

      // Format số tiền
      function formatCurrency(amount) {
        return new Intl.NumberFormat("vi-VN", {
          style: "currency",
          currency: "VND",
        }).format(amount);
      }

      // Format thời gian
      function formatDateTime(dateString) {
        if (!dateString) return 'N/A';
        try {
          return new Date(dateString).toLocaleString('vi-VN');
        } catch (e) {
          console.error('Error formatting date:', e);
          return 'Invalid Date';
        }
      }

      // Generic fetch helper
      async function fetchData(endpoint) {
          const token = checkAuth();
          if (!token) { // checkAuth redirects if no token, but this is a safeguard
              return null;
          }
          try {
              const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                  headers: {
                      Authorization: `Bearer ${token}`,
                  },
              });

              if (!response.ok) {
                  console.error(`API error: ${response.status} ${response.statusText}`);
                  // Attempt to read error message from body
                  const errorBody = await response.text();
                  console.error('Error details:', errorBody);
                  try {
                      const errorJson = JSON.parse(errorBody);
                      throw new Error(errorJson.message || `API error ${response.status}`);
                  } catch (e) {
                      throw new Error(`API error ${response.status}: ${errorBody || response.statusText}`);
                  }
              }

              return await response.json();
          } catch (error) {
              console.error(`Error fetching ${endpoint}:`, error);
              // Propagate error to be handled by the caller
              throw error;
          }
      }

      // --- Data Fetching Functions ---

      // Lấy tổng doanh thu
      async function getTotalRevenue() {
        try {
          const data = await fetchData("/total");
          if (data && data.success && data.data) {
            document.getElementById("totalRevenue").textContent = formatCurrency(
              data.data.TotalRevenue || 0
            );
          } else {
             document.getElementById("totalRevenue").textContent = formatCurrency(0);
             console.warn('Total revenue data not successful or empty:', data);
          }
        } catch (error) {
          console.error("Error fetching total revenue:", error);
          document.getElementById("totalRevenue").textContent = 'Error';
        }
      }

      // Lấy doanh thu theo ngày (cho biểu đồ)
      async function getDailyRevenue() {
        try {
          const data = await fetchData("/daily");
          if (data && data.success && Array.isArray(data.data)) {
            const dailyData = data.data;
            const dates = dailyData.map((item) =>
              new Date(item.Date).toLocaleDateString("vi-VN")
            );
            const revenues = dailyData.map((item) => item.DailyRevenue);

            new Chart(document.getElementById("dailyRevenueChart"), {
              type: "line",
              data: {
                labels: dates,
                datasets: [
                  {
                    label: "Doanh thu theo ngày",
                    data: revenues,
                    borderColor: "#0083b0",
                    tension: 0.1,
                  },
                ],
              },
              options: {
                responsive: true,
                plugins: {
                  title: {
                    display: true,
                    text: "Biểu đồ doanh thu theo ngày",
                  },
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: {
                      callback: function (value) {
                        return formatCurrency(value);
                      },
                    },
                  },
                },
              },
            });
          } else {
              console.warn('Daily revenue data not successful or not an array:', data);
              // Optionally show an empty chart or an error message on the chart canvas
          }
        } catch (error) {
          console.error("Error fetching daily revenue:", error);
           // Optionally show an error message on the chart canvas
        }
      }

      // Lấy doanh thu theo tháng và năm (cho biểu đồ và bảng)
      async function getMonthlyYearlyRevenue() {
        try {
          const data = await fetchData("/monthly-yearly");
          if (data && data.success && Array.isArray(data.data)) {
            const monthlyData = data.data;

            // Chart data (by month/year)
            const chartLabels = monthlyData.map(
              (item) => `${item.Month}/${item.Year}`
            ).reverse(); // Reverse to show oldest first on chart
            const chartRevenues = monthlyData.map((item) => item.Revenue).reverse();

            new Chart(document.getElementById("monthlyRevenueChart"), {
              type: "bar",
              data: {
                labels: chartLabels,
                datasets: [
                  {
                    label: "Doanh thu theo tháng",
                    data: chartRevenues,
                    backgroundColor: "#0083b0",
                  },
                ],
              },
              options: {
                responsive: true,
                plugins: {
                  title: {
                    display: true,
                    text: "Biểu đồ doanh thu theo tháng",
                  },
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: {
                      callback: function (value) {
                        return formatCurrency(value);
                      },
                    },
                  },
                },
              },
            });

            // Table data (monthly details)
            const tableBody = document.querySelector(
              "#monthlyRevenueTable tbody"
            );
            // The previous version changed #monthlyRevenueTable to #dailyInvoicesTable. Let's keep #dailyInvoicesTable for the detailed date view, and perhaps rename this section or table if needed, but for now, this table is no longer used for monthly details based on the previous edit. 
            // Let's keep the dailyInvoicesTable for the date filter results and remove the old monthly table update logic.
            
            // Previous monthly table update logic removed as it was replaced by dailyInvoicesTable

          } else {
              console.warn('Monthly/yearly revenue data not successful or not an array:', data);
               // Optionally show an empty chart or an error message on the chart canvas
          }
        } catch (error) {
          console.error("Error fetching monthly/yearly revenue:", error);
           // Optionally show an error message on the chart canvas
        }
      }

      // Lấy doanh thu theo ngày cụ thể (cho bảng chi tiết)
      async function getRevenueByDate(date) {
        const tableBody = document.querySelector("#dailyInvoicesTable tbody");
        tableBody.innerHTML = `
          <tr>
            <td colspan="5" class="loading-data">Đang tải dữ liệu cho ngày ${date}...</td>
          </tr>
        `;
         document.getElementById("selectedDateRevenue").textContent = 'Loading...';

        try {
          const data = await fetchData(`/by-date?date=${date}`);
          if (data && data.success && Array.isArray(data.data)) {
            const invoices = data.data;
            
            // Tính tổng doanh thu của ngày
            const totalRevenue = invoices.reduce(
              (sum, invoice) => sum + invoice.TongTien,
              0
            );
            document.getElementById("selectedDateRevenue").textContent = formatCurrency(totalRevenue);

            // Cập nhật bảng chi tiết
            tableBody.innerHTML = ""; // Clear loading/placeholder

            if (invoices.length === 0) {
              tableBody.innerHTML = `
                <tr>
                  <td colspan="5" class="loading-data">Không có dữ liệu hóa đơn cho ngày này</td>
                </tr>
              `;
              return;
            }

            invoices.forEach((invoice) => {
              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${invoice.ID_HoaDon}</td>
                <td>${formatDateTime(invoice.NgayThanhToan)}</td>
                <td>${invoice.CustomerName || "N/A"}</td>
                <td>${invoice.CustomerPhone || "N/A"}</td>
                <td>${formatCurrency(invoice.TongTien)}</td>
              `;
              tableBody.appendChild(row);
            });
          } else {
               document.getElementById("selectedDateRevenue").textContent = formatCurrency(0);
                tableBody.innerHTML = `
                <tr>
                  <td colspan="5" class="loading-data">Không có dữ liệu hoặc lỗi khi tải</td>
                </tr>
              `;
              console.warn('Revenue by date data not successful or not an array:', data);
          }
        } catch (error) {
          console.error("Error fetching revenue by date:", error);
          document.getElementById("selectedDateRevenue").textContent = 'Error';
           tableBody.innerHTML = `
                <tr>
                  <td colspan="5" class="loading-data">Lỗi khi tải dữ liệu: ${error.message}</td>
                </tr>
              `;
        }
      }

      // --- Event Handlers and Initialization ---

      // Hàm lọc theo ngày
      function filterByDate() {
        const dateInput = document.getElementById("dateFilter");
        if (dateInput.value) {
          // Format date to YYYY-MM-DD as expected by the backend API
          const selectedDate = new Date(dateInput.value);
          const formattedDate = selectedDate.toISOString().split('T')[0];
          getRevenueByDate(formattedDate);
        } else {
          alert("Vui lòng chọn ngày");
        }
      }

      // Khởi tạo tải dữ liệu ban đầu
      async function initDataLoading() {
        // Ensure authenticated before loading data
        if (!checkAuth()) return; // checkAuth redirects if no token

        // Initial state for tables/stats before data loads
         document.getElementById("totalRevenue").textContent = 'Loading...';
         document.getElementById("selectedDateRevenue").textContent = '-'; // Clear previous
         document.querySelector("#dailyInvoicesTable tbody").innerHTML = `
            <tr>
              <td colspan="5" class="loading-initial">Đang tải dữ liệu...</td>
            </tr>
          `;
         // Chart placeholders could also be added if needed

        try {
          // Load all initial data concurrently
          await Promise.all([
            getTotalRevenue(),
            getDailyRevenue(),
            getMonthlyYearlyRevenue(),
          ]);
           // If all initial loads succeed, remove the initial loading message from the daily invoices table
           const dailyInvoicesTableBody = document.querySelector("#dailyInvoicesTable tbody");
           if(dailyInvoicesTableBody.querySelector('.loading-initial')){
                dailyInvoicesTableBody.innerHTML = `
                <tr>
                  <td colspan="5" class="loading-initial">Vui lòng chọn ngày để xem chi tiết</td>
                </tr>
              `;
           }

        } catch (error) {
          console.error('Error during initial data loading:', error);
           // Handle overall loading error if necessary
           document.getElementById("totalRevenue").textContent = 'Error';
           document.querySelector("#dailyInvoicesTable tbody").innerHTML = `
            <tr>
              <td colspan="5" class="loading-initial">Lỗi khi tải dữ liệu ban đầu. Vui lòng thử lại.</td>
            </tr>
          `;
        }
      }

      // Chạy khi trang được tải
      document.addEventListener("DOMContentLoaded", () => {
           initDataLoading();
           // Add event listener for the date filter button AFTER the DOM is loaded
           document.querySelector('.filter-btn').addEventListener('click', filterByDate);
      });

      // Optional: Add event listener for pressing Enter in the date input
      document.getElementById('dateFilter').addEventListener('keypress', function(event) {
          if (event.key === 'Enter') {
              event.preventDefault(); // Prevent form submission if this was inside a form
              filterByDate();
          }
      });

    </script>
  </body>
</html>
